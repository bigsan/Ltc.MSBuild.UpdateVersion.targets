<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="VersionInfo.targets" />

  <Target Name="UpdateVersion"
          DependsOnTargets="CreateVersionProperty"
          BeforeTargets="BeforeBuild"
          Condition="$(Configuration.ToLower().StartsWith('release'))">
    <Message Text="*** Updating $(VersionFilePath)" Importance="high" />
    <Message Text="*** Set assembly version to $(AssemblyVersion)" Importance="high" />
    <Message Text="*** Set file version to $(AssemblyFileVersion)" Importance="high" />

    <ModifyAssemblyInfo VersionFilePath="$(VersionFilePath)"
                        AssemblyVersion="$(AssemblyVersion)"
                        AssemblyFileVersion="$(AssemblyFileVersion)"/>
  </Target>

  <Target Name="CreateVersionProperty">
    <TfsHistory ItemSpec="$(ProjectDir)">
      <Output TaskParameter="ChangesetId" PropertyName="ChangesetId" />
      <Output TaskParameter="Committer" PropertyName="Committer" />
      <Output TaskParameter="CommitterDisplayName" PropertyName="CommitterDisplayName" />
      <Output TaskParameter="CreationDate" PropertyName="CreationDate" />
      <Output TaskParameter="Comment" PropertyName="Comment" />
    </TfsHistory>
    <PropertyGroup>
      <DateTag>$([System.DateTime]::Parse($(CreationDate)).ToString(Mdd))</DateTag>
    </PropertyGroup>

    <PropertyGroup>
      <AssemblyVersion>$(MajorVersion).$(MinorVersion).0.0</AssemblyVersion>
      <AssemblyFileVersion>$(MajorVersion).$(MinorVersion).$(ChangesetId).$(DateTag)</AssemblyFileVersion>
    </PropertyGroup>
  </Target>

  <UsingTask TaskName="ModifyAssemblyInfo" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <VersionFilePath     ParameterType="System.String" Required="true" />
      <AssemblyVersion     ParameterType="System.String" Required="true" />
      <AssemblyFileVersion ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System.IO" />
      <Using Namespace="System.Text.RegularExpressions" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
        if (!File.Exists(this.VersionFilePath)) throw new FileNotFoundException(null, this.VersionFilePath);
        System.Version.Parse(this.AssemblyVersion);
        System.Version.Parse(this.AssemblyFileVersion);

        var txt = File.ReadAllText(this.VersionFilePath);
        txt = Regex.Replace(txt, @"(?m)(?<=^\[assembly:\sAssemblyVersion\("")[\d\.]+(?=""\)\])", this.AssemblyVersion);
        txt = Regex.Replace(txt, @"(?m)(?<=^\[assembly:\sAssemblyFileVersion\("")[\d\.]+(?=""\)\])", this.AssemblyFileVersion);

        new FileInfo(this.VersionFilePath).IsReadOnly = false;
        File.WriteAllText(this.VersionFilePath, txt);
        ]]>
      </Code>
    </Task>
  </UsingTask>

  <UsingTask TaskName="TfsHistory" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <ItemSpec             ParameterType="System.String"   Required="true" />
      <ChangesetId          ParameterType="System.Int32"    Required="false" Output="true" />
      <Committer            ParameterType="System.String"   Required="false" Output="true" />
      <CommitterDisplayName ParameterType="System.String"   Required="false" Output="true" />
      <CreationDate         ParameterType="System.DateTime" Required="false" Output="true" />
      <Comment              ParameterType="System.String"   Required="false" Output="true" />
    </ParameterGroup>
    <Task>
      <Reference Include="Microsoft.TeamFoundation.Client" />
      <Reference Include="Microsoft.TeamFoundation.VersionControl.Client" />
      <Using Namespace="Microsoft.TeamFoundation.Client"/>
      <Using Namespace="Microsoft.TeamFoundation.VersionControl.Client"/>
      <Code Type="Fragment" Language="cs">
        <![CDATA[
        this.CreationDate = DateTime.Now;
        try
        {
          var serverUri = Workstation.Current.GetLocalWorkspaceInfo(this.ItemSpec).ServerUri;
          var collection = new TfsTeamProjectCollection(serverUri);
          var versionControl = collection.GetService<VersionControlServer>();

          var changeset = versionControl.QueryHistory(this.ItemSpec, VersionSpec.Latest, 0, RecursionType.Full, Environment.UserName, null, null, 1, true, false).Cast<Changeset>().FirstOrDefault();
          var prop = changeset.GetType().GetProperty("CommitterDisplayName");

          if (changeset != null)
          {
            this.ChangesetId = changeset.ChangesetId;
            this.Committer = changeset.Committer;
            this.CommitterDisplayName = prop == null ? changeset.Committer : (string)prop.GetValue(changeset);
            this.CreationDate = changeset.CreationDate;
            this.Comment = changeset.Comment;
          }
        }
        catch { }
        ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>